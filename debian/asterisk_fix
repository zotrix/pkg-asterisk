#/bin/sh 

if (getent passwd asterisk >/dev/null);then
        if [ "`getent passwd asterisk|awk -F: '{print $6}'`" = "/var/run/asterisk" ];then
	            usermod -d /var/lib/asterisk asterisk
        fi
else
        adduser --system --group --home /var/lib/asterisk --gecos "Asterisk PBX daemon" asterisk
        adduser asterisk audio
        adduser asterisk dialout
fi

if (groups asterisk | grep -w -q -v asterisk); then
        adduser asterisk dialout
fi


test -d /var/log/asterisk || mkdir -p /var/log/asterisk
test -d /var/lib/asterisk || mkdir -p /var/lib/asterisk
test -d /etc/asterisk || mkdir -p /etc/asterisk
test -d /var/spool/asterisk/ || mkdir -p /var/spool/asterisk/
chown -R asterisk.asterisk \
        /var/log/asterisk \
        /var/run/asterisk \
        /var/spool/asterisk \ 
        /var/lib/asterisk \
        /etc/asterisk
chmod 0660 /etc/asterisk/*.conf


####################################
# TODO:
#
# the real setup should be :
#   if asterisk is not running - start it
#   otherwise reload. 
#   reload may fail, but start should not (it will be run on fist install only)
#
# for simplicity, we just restart it by force right now.

if [ -x /etc/init.d/asterisk ]; then
##        /etc/init.d/asterisk reload || true
        /etc/init.d/asterisk restart
fi
