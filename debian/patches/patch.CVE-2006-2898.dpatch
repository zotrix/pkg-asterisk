#! /bin/sh /usr/share/dpatch/dpatch-run
## 99_CVE-2006-2898.dpatch by Joey Schulze <joey@debian.org>
##
## DP: Bug in the IAX2 channel allows remote attackers to craft
## DP: a denial of service.

@DPATCH@
diff -urNad asterisk-1.2.10.dfsg~/channels/chan_iax2.c asterisk-1.2.10.dfsg/channels/chan_iax2.c
--- asterisk-1.2.10.dfsg~/channels/chan_iax2.c	2006-07-12 16:23:59.000000000 +0100
+++ asterisk-1.2.10.dfsg/channels/chan_iax2.c	2006-07-27 08:17:52.000000000 +0100
@@ -6531,7 +6531,7 @@
 	if (iaxdebug && (res >= sizeof(*fh)))
 		iax_showframe(NULL, fh, 1, &sin, res - sizeof(*fh));
 #endif
-	if (ntohs(mh->callno) & IAX_FLAG_FULL) {
+	if ((res >= sizeof(*fh)) && ntohs(mh->callno) & IAX_FLAG_FULL) {
 		if (res < sizeof(*fh)) {
 			ast_log(LOG_WARNING, "Rejecting packet from '%s.%d' that is flagged as a full frame but is too short\n", ast_inet_ntoa(iabuf, sizeof(iabuf), sin.sin_addr), ntohs(sin.sin_port));
 			return 1;
