Fix CVE-2007-4521/AST-2007-021 remote denial of service when using IMAP

Taken from upstream SVN http://svn.digium.com/view/asterisk?view=rev&rev=80750

Merged in 1.4.12.

 -- Kilian Krause <kilian@debian.org>

diff -urNad asterisk-1.4.11~dfsg~/apps/app_voicemail.c asterisk-1.4.11~dfsg/apps/app_voicemail.c
--- asterisk-1.4.11~dfsg~/apps/app_voicemail.c	2007-08-20 17:34:43.000000000 +0200
+++ asterisk-1.4.11~dfsg/apps/app_voicemail.c	2007-08-30 17:40:08.000000000 +0200
@@ -4421,7 +4421,7 @@
 	mail_fetchstructure (vms->mailstream,vms->msgArray[vms->curmsg],&body);
 	
 	/* We have the body, now we extract the file name of the first attachment. */
-	if (body->nested.part->next && body->nested.part->next->body.parameter->value) {
+	if (body->nested.part && body->nested.part->next && body->nested.part->next->body.parameter->value) {
 		attachedfilefmt = ast_strdupa(body->nested.part->next->body.parameter->value);
 	} else {
 		ast_log(LOG_ERROR, "There is no file attached to this IMAP message.\n");
diff -urNad asterisk-1.4.11~dfsg~/x asterisk-1.4.11~dfsg/x
--- asterisk-1.4.11~dfsg~/x	1970-01-01 01:00:00.000000000 +0100
+++ asterisk-1.4.11~dfsg/x	2007-08-30 17:39:58.000000000 +0200
@@ -0,0 +1,11 @@
+--- branches/1.4/apps/app_voicemail.c (original)
++++ branches/1.4/apps/app_voicemail.c Fri Aug 24 10:51:03 2007
+@@ -4421,7 +4421,7 @@
+ 	mail_fetchstructure (vms->mailstream,vms->msgArray[vms->curmsg],&body);
+ 	
+ 	/* We have the body, now we extract the file name of the first attachment. */
+-	if (body->nested.part->next && body->nested.part->next->body.parameter->value) {
++	if (body->nested.part && body->nested.part->next && body->nested.part->next->body.parameter->value) {
+ 		attachedfilefmt = ast_strdupa(body->nested.part->next->body.parameter->value);
+ 	} else {
+ 		ast_log(LOG_ERROR, "There is no file attached to this IMAP message.\n");
