#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# This file is public domain software, originally written by Joey Hess. 

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatibility version to use.
export DH_COMPAT=4

export DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
export DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
  confflags += --build $(DEB_HOST_GNU_TYPE)
else
  confflags += --build $(DEB_BUILD_GNU_TYPE) --host $(DEB_HOST_GNU_TYPE)
endif

export PROC := $(shell dpkg-architecture -qDEB_HOST_ARCH)

OPTFLAGS= -O2

ifeq ($(DEB_HOST_ARCH),amd64)
OPTFLAGS+= -m64
endif

export OPTFLAGS

ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -g
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	INSTALL_PROGRAM += -s
endif

#export OPENH323DIR=/usr/share/openh323
#export PWLIBDIR=/usr/share/pwlib

include /usr/share/dpatch/dpatch.make

check-sounds:
	( [ ! -f sounds/fpm-calm-river.mp3 ] && \
	  [ ! -f sounds/fpm-sunshine.mp3 ]   && \
	  [ ! -f sounds/fpm-world-mix.mp3 ] ) || \
		(echo "WARNING: fpm sounds must to be removed from sources before packaging." ; false )
	

configure: check-sounds patch 
	dh_testdir
	# Add here commands to configure the package.
	- (cd editline ; \
	if [ -f config.sub.old ]; then \
	  rm -f config.sub; \
	else \
	  mv config.sub config.sub.old; \
	fi; \
	if [ -f config.guess.old ]; then \
	  rm -f config.guess; \
	else \
	  mv config.guess config.guess.old; \
	fi; \
	ln -s /usr/share/misc/config.sub config.sub; \
	ln -s /usr/share/misc/config.guess config.guess; \
	cd ..)
	cd editline;./configure $(confflags)
	touch configure-stamp

build-arch: configure  build-arch-stamp
build-arch-stamp:
	dh_testdir

	# Add here command to compile/build the package.
	#cd channels/h323; make
	$(MAKE)

	touch build-arch-stamp

build-indep:  configure build-indep-stamp
build-indep-stamp:
	dh_testdir

	# Add here command to compile/build the arch indep package.
	# It's ok not to do anything here, if you don't need to build
	#  anything for this package.
	#/usr/bin/docbook-to-man debian/asterisk.sgml > asterisk.1
	$(MAKE) progdocs

	touch build-indep-stamp


build: build-arch build-indep

clean: unpatch cleaned 
cleaned:
	dh_testdir
	dh_testroot
	-$(RM) -f build-arch-stamp build-indep-stamp configure 

	# Add here commands to clean up after the build process.
	#-$(MAKE) -C channels/h323 clean
	-$(MAKE) clean
	-$(RM) -fR doc/api agi/eagi-test agi/eagi-sphinx-test
	-$(RM) debian/asterisk.8.gz
	-(cd editline; \
	if [ -f config.sub.old ]; then \
	   mv config.sub.old config.sub; \
	fi; \
	if [ -f config.guess.old ]; then \
	   mv config.guess.old config.guess; \
	fi; \
	cd ..)

	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs var/run/asterisk

	# Add here commands to install the package into debian/<packagename>
	$(MAKE) INSTALL_PREFIX=$(CURDIR)/debian/tmp install samples
	cp debian/asterisk.conf $(CURDIR)/debian/tmp/etc/asterisk/asterisk.conf
	#cp channels/h323/h323.conf.sample $(CURDIR)/debian/tmp/etc/asterisk/h323.conf
	cp contrib/scripts/addmailbox $(CURDIR)/debian/tmp/usr/sbin/
	chmod +x $(CURDIR)/debian/tmp/usr/sbin/addmailbox
	mkdir -p $(CURDIR)/debian/tmp/etc/default/
	cp debian/asterisk.default $(CURDIR)/debian/tmp/etc/default/asterisk
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/cgi-bin/asterisk/
	cp contrib/scripts/vmail.cgi $(CURDIR)/debian/tmp/usr/lib/cgi-bin/asterisk/
	chmod +x $(CURDIR)/debian/tmp/usr/lib/cgi-bin/asterisk/vmail.cgi

	zcat asterisk.8.gz|gzip -9c >debian/asterisk.8.gz
	chmod -x $(CURDIR)/debian/tmp/usr/share/doc/asterisk-doc/examples/festival.conf.sample

	dh_install --sourcedir=debian/tmp

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installdocs -i
	dh_installman debian/asterisk.8.gz
	dh_installexamples -i -XCVS
	dh_installcron -i
	dh_installchangelogs ChangeLog -i
	dh_link -i 
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i


# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a
	dh_installexamples -a -XCVS
	dh_installlogrotate -a
	dh_installinit -a -- defaults 21
	dh_installchangelogs ChangeLog -a
	dh_strip -a
	dh_link -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	rm debian/asterisk/usr/lib/asterisk/modules/pbx_gtkconsole.so
	#rm debian/asterisk/usr/lib/asterisk/modules/chan_h323.so
	dh_makeshlibs -a -V 'libpri1 (>= 1.0.4-2)'
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure clean 
